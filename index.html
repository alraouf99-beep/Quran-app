<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>محاكي مدرسة الدوامة - الإصدار النهائي الشامل</title>
    <style>
        :root { --p: #004d40; --g: #c09b52; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; text-align: right; direction: rtl; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-top: 10px solid var(--p); }
        .logic-ref { background: #e0f2f1; padding: 15px; border-radius: 12px; font-size: 13px; margin-bottom: 20px; border-right: 5px solid var(--g); line-height: 1.8; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        label { font-weight: bold; color: var(--p); display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; background: var(--p); color: white; padding: 18px; border: none; border-radius: 15px; font-size: 20px; cursor: pointer; font-weight: bold; }
        #result { margin-top: 30px; display: none; }
        .res-table { width: 100%; border-collapse: collapse; }
        .res-table th { background: var(--p); color: white; padding: 12px; }
        .res-table td { padding: 12px; border: 1px solid #eee; text-align: center; }
        .highlight { color: #2e7d32; font-weight: bold; font-size: 1.1em; }
        .step-tag { font-size: 11px; background: #eee; padding: 2px 5px; border-radius: 4px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>محاكي مدرسة الدوامة - التوزيع القرآني الشامل</h2>
    
    <div class="logic-ref">
        • <b>الترتيب:</b> الزوجة (آية 12) من الأصل ← الوالدان (آية 11) من الباقي ← الأولاد (أسهم).<br>
        • <b>الكلالة:</b> تُفعل عند غياب (الولد، الأب، الأم). <br>
        • <b>الفرق البرمجي:</b> نميز بين 'rajul' (متزوج - آية 12) و 'imru' (أعزب - آية 176) في الكلالة.
    </div>

    <div class="input-grid">
        <div style="grid-column: 1/-1;"><label>مبلغ التركة الكلي (MAD):</label><input type="number" id="estate" value="2400"></div>
        <div><label>الحالة الزوجية:</label><select id="spouse"><option value="none">أعزب/عزباء</option><option value="wife">رجل ترك زوجة</option><option value="husband">امرأة تركت زوجاً</option></select></div>
        <div><label>الأب:</label><select id="hasF"><option value="0">متوفى</option><option value="1">حي</option></select></div>
        <div><label>الأم:</label><select id="hasM"><option value="0">متوفاة</option><option value="1">حية</option></select></div>
        <div><label>ذكور (أبناء):</label><input type="number" id="mC" value="0"></div>
        <div><label>إناث (بنات):</label><input type="number" id="fC" value="0"></div>
        <div><label>إخوة ذكور:</label><input type="number" id="mS" value="0"></div>
        <div><label>إخوة إناث:</label><input type="number" id="fS" value="0"></div>
    </div>

    <button onclick="runVortexFinal()">تحليل التركة وتشغيل الدوامة</button>

    <div id="result">
        <table class="res-table">
            <thead>
                <tr><th>الوارث</th><th>المرحلة والمنطق</th><th>المبلغ المستحق</th></tr>
            </thead>
            <tbody id="resBody"></tbody>
        </table>
    </div>
</div>

<script>
function runVortexFinal() {
    const estate = parseFloat(document.getElementById('estate').value);
    const mC = parseInt(document.getElementById('mC').value) || 0;
    const fC = parseInt(document.getElementById('fC').value) || 0;
    const nC = mC + fC; 
    const sp = document.getElementById('spouse').value;
    const hasF = document.getElementById('hasF').value === "1";
    const hasM = document.getElementById('hasM').value === "1";
    const mS = parseInt(document.getElementById('mS').value) || 0;
    const fS = parseInt(document.getElementById('fS').value) || 0;
    const nS = mS + fS;

    let balance = estate;
    let table = "";
    let spouseFinal = 0;

    // المرحلة 1: الزوجية (من الأصل)
    let sRate = 0;
    if (sp === 'wife') sRate = (nC > 0) ? 1/8 : 1/4;
    else if (sp === 'husband') sRate = (nC > 0) ? 1/4 : 1/2;
    
    spouseFinal = estate * sRate;
    if (spouseFinal > 0) {
        table += `<tr><td>الزوج/ة</td><td><span class="step-tag">مرحلة 1</span> آية 12 (أصل)</td><td class="highlight">${spouseFinal.toLocaleString()}</td></tr>`;
        balance -= spouseFinal;
    }

    // المرحلة 2: الوالدان (من الباقي - آية 11)
    const isKhalala = !hasF && !hasM && nC === 0;
    if (!isKhalala) {
        if (hasM) {
            let mRate = (nC > 0 || nS >= 2) ? 1/6 : 1/3;
            let mA = balance * mRate;
            table += `<tr><td>الأم</td><td><span class="step-tag">مرحلة 2</span> آية 11 (باقي)</td><td class="highlight">${mA.toLocaleString()}</td></tr>`;
            balance -= mA;
        }
        if (hasF) {
            let fA = balance * (1/6);
            table += `<tr><td>الأب</td><td><span class="step-tag">مرحلة 2</span> آية 11 (باقي)</td><td class="highlight">${fA.toLocaleString()}</td></tr>`;
            balance -= fA;
        }
    }

    // المرحلة 3: الولد أو الكلالة (قاع الدوامة)
    if (nC > 0) {
        // حالة وجود ولد: توزيع بالأسهم (2:1) لامتصاص كامل المتبقي
        let totalParts = (mC * 2) + fC;
        let partVal = balance / totalParts;
        if (mC > 0) table += `<tr><td>الابن (الواحد)</td><td>أسهم (2)</td><td class="highlight">${(partVal*2).toLocaleString()}</td></tr>`;
        if (fC > 0) table += `<tr><td>البنت (الواحدة)</td><td>سهم (1)</td><td class="highlight">${partVal.toLocaleString()}</td></tr>`;
        balance = 0;
    } 
    else if (isKhalala && nS > 0) {
        // حالة الكلالة
        if (sp !== 'none') {
            // "رجل" (متزوج) - آية 12: السدس أو الثلث
            let sibRate = (nS === 1) ? 1/6 : 1/3;
            let sibAmount = balance * sibRate;
            table += `<tr><td>الإخوة (شركاء)</td><td><span class="step-tag">كلالة</span> آية 12</td><td class="highlight">${sibAmount.toLocaleString()}</td></tr>`;
            balance -= sibAmount; // الفائض يذهب للرد على الزوجة
        } else {
            // "امرؤ" (أعزب) - آية 176: توزيع كامل بالأسهم
            let totalSibParts = (mS * 2) + fS;
            if (mS > 0) {
                let pVal = balance / totalSibParts;
                table += `<tr><td>الأخ (تفاضل)</td><td>أسهم (2)</td><td class="highlight">${(pVal*2).toLocaleString()}</td></tr>`;
                table += `<tr><td>الأخت (تفاضل)</td><td>سهم (1)</td><td class="highlight">${pVal.toLocaleString()}</td></tr>`;
                balance = 0;
            } else {
                // أخوات فقط: نصف أو ثلثين
                let sRate = (fS === 1) ? 1/2 : 2/3;
                let sAmount = balance * sRate;
                table += `<tr><td>الأخوات</td><td>آية 176 (${(sRate*100).toFixed(1)}%)</td><td class="highlight">${sAmount.toLocaleString()}</td></tr>`;
                balance -= sAmount;
            }
        }
    }

    // المرحلة 4: الرد (الزوجة من الأقربون)
    if (balance > 0 && sp !== 'none') {
        table += `<tr style="background:#fffde7"><td>رد للزوجة (أقربون)</td><td>فائض الدوامة</td><td class="highlight">${balance.toLocaleString()}</td></tr>`;
    } else if (balance > 0) {
        table += `<tr style="background:#f1f8e9"><td>رد للورثة</td><td>فائض الدوامة</td><td class="highlight">${balance.toLocaleString()}</td></tr>`;
    }

    document.getElementById('resBody').innerHTML = table;
    document.getElementById('result').style.display = 'block';
}
</script>
</body>
</html>
